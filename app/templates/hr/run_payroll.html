
{% extends "_shared/dashboard_layout.html" %}

{% block content %}
<div class="py-10 px-4 sm:px-6 lg:px-8" 
     x-data="payrollRunForm()" 
     x-init="init()">
    
  <form method="POST" action="/hr/payroll/run">
        <div class="flex items-center justify-between mb-6">
            <div>
                <h1 class="text-3xl font-bold leading-tight text-gray-900 dark:text-white">Run Payroll</h1>
                <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">
                    Processing payroll for branch: <span class="font-semibold text-blue-500">{{ selected_branch.name }}</span>
                </p>
            </div>
            <div>
                <button type="submit" 
                        class="text-white font-medium rounded-lg text-sm px-5 py-2.5 text-center"
                        :class="{ 'bg-blue-700 hover:bg-blue-800': employeesToPay.length > 0, 'bg-gray-400 cursor-not-allowed': employeesToPay.length === 0 }"
                        :disabled="employeesToPay.length === 0">
                    Process Payroll for <span x-text="employeesToPay.length"></span> Employee(s)
                </button>
            </div>
        </div>

        <!-- Pay Period Selector -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6 p-6 bg-white dark:bg-gray-800 rounded-lg shadow-sm">
            <div>
                <label for="pay_period_start" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Pay Period Start</label>
                <input type="date" name="pay_period_start" x-model="payPeriodStart" @change="filterEmployees" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600" required>
            </div>
            <div>
                <label for="pay_period_end" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Pay Period End</label>
                <input type="date" name="pay_period_end" x-model="payPeriodEnd" @change="filterEmployees" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600" required>
            </div>
            <div>
                <label for="pay_frequency_filter" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Filter by Frequency</label>
                <select x-model="frequencyFilter" @change="filterEmployees" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600">
                    <option value="All">All</option>
                    <option value="Monthly">Monthly</option>
                    <option value="Weekly">Weekly</option>
                    <option value="Bi-Weekly">Bi-Weekly</option>
                </select>
            </div>
        </div>

        <!-- Employees Table -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm overflow-hidden">
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                    <thead class="bg-gray-50 dark:bg-gray-700">
                        <tr>
                            <th class="p-4"><input type="checkbox" @click="toggleSelectAll($event.target.checked)" class="rounded"></th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Employee</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Gross Salary</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Bonuses</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Deductions</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200 dark:divide-gray-700">
                        <template x-for="employee in filteredEmployees" :key="employee.id">
                            <tr>
                                <td class="p-4"><input type="checkbox" :value="employee.id" x-model="employee.selected" class="rounded"></td>
                                <td class="px-6 py-4">
                                    <div class="text-sm font-medium text-gray-900 dark:text-white" x-text="employee.full_name"></div>
                                    <div class="text-xs text-gray-500 dark:text-gray-400" x-text="employee.payroll_config.pay_frequency"></div>
                                </td>
                                <td class="px-6 py-4 text-sm text-gray-500 dark:text-gray-300" x-text="formatCurrency(employee.payroll_config.gross_salary)"></td>
                                <td class="px-6 py-4">
                                    <template x-for="(addition, index) in employee.additions" :key="index">
                                        <div class="flex items-center gap-2 mb-2">
                                            <input type="text" x-model="addition.description" placeholder="Bonus description" class="bg-gray-50 border-gray-300 text-sm rounded-lg w-full p-2 dark:bg-gray-700">
                                            <input type="number" step="0.01" x-model.number="addition.amount" placeholder="Amount" class="bg-gray-50 border-gray-300 text-sm rounded-lg w-32 p-2 dark:bg-gray-700">
                                            <button type="button" @click="removeRow(employee, 'additions', index)" class="text-red-500">&times;</button>
                                        </div>
                                    </template>
                                    <button type="button" @click="addRow(employee, 'additions')" class="text-xs text-blue-500 hover:underline">+ Add Bonus</button>
                                </td>
                                <td class="px-6 py-4">
                                    <template x-for="(deduction, index) in employee.deductions" :key="index">
                                        <div class="flex items-center gap-2 mb-2">
                                            <input type="text" x-model="deduction.description" placeholder="Deduction description" class="bg-gray-50 border-gray-300 text-sm rounded-lg w-full p-2 dark:bg-gray-700">
                                            <input type="number" step="0.01" x-model.number="deduction.amount" placeholder="Amount" class="bg-gray-50 border-gray-300 text-sm rounded-lg w-32 p-2 dark:bg-gray-700">
                                            <button type="button" @click="removeRow(employee, 'deductions', index)" class="text-red-500">&times;</button>
                                        </div>
                                    </template>
                                    <button type="button" @click="addRow(employee, 'deductions')" class="text-xs text-blue-500 hover:underline">+ Add Deduction</button>
                                </td>
                            </tr>
                        </template>
                        <template x-if="filteredEmployees.length === 0">
                            <tr>
                                <td colspan="5" class="text-center py-10 text-gray-500">No employees match the selected criteria in this branch.</td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>
        </div>
        <input type="hidden" name="payroll_data" :value="JSON.stringify(employeesToPay)">
    </form>
</div>

<script id="payroll-data" type="application/json">
    {{ employees_data | tojson | safe }}
</script>

<script>
function payrollRunForm() {
    return {
        allEmployees: [],
        filteredEmployees: [],
        payPeriodStart: '',
        payPeriodEnd: '',
        frequencyFilter: 'All',

        init() {
            const dataEl = document.getElementById('payroll-data');
            const employeesData = JSON.parse(dataEl.textContent);

            this.allEmployees = employeesData.map(emp => ({
                ...emp,
                selected: false,
                additions: [],
                deductions: []
            }));
            this.filteredEmployees = [...this.allEmployees];
        },

        filterEmployees() {
            if (this.frequencyFilter === 'All') {
                this.filteredEmployees = [...this.allEmployees];
            } else {
                this.filteredEmployees = this.allEmployees.filter(emp => 
                    emp.payroll_config && emp.payroll_config.pay_frequency === this.frequencyFilter
                );
            }
        },

        toggleSelectAll(checked) {
            this.filteredEmployees.forEach(emp => emp.selected = checked);
        },

        addRow(employee, type) {
            employee[type].push({ description: '', amount: 0.00 });
        },

        removeRow(employee, type, index) {
            employee[type].splice(index, 1);
        },

        get employeesToPay() {
            return this.allEmployees
                .filter(emp => emp.selected)
                .map(emp => ({
                    employee_id: emp.id,
                    additions: emp.additions.filter(a => a.description && a.amount > 0),
                    deductions: emp.deductions.filter(d => d.description && d.amount > 0)
                }));
        },

        formatCurrency(value) {
            return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(value || 0);
        }
    }
}
</script>
{% endblock %}
