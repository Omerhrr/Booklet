{% extends "_shared/dashboard_layout.html" %}

{% block content %}
<div class="py-10 px-4 sm:px-6 lg:px-8">
    <form id="debit-note-form" method="POST" action="/purchases/new-debit-note">
        <!-- Header -->
        <div class="flex items-center justify-between mb-6">
            <div>
                <h1 class="text-3xl font-bold leading-tight text-gray-900 dark:text-white">New Debit Note</h1>
                <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">Create a return by selecting a vendor and a specific bill.</p>
            </div>
            <div>
                <button type="submit" class="text-white bg-blue-700 hover:bg-blue-800 font-medium rounded-lg text-sm px-5 py-2.5 text-center">Create Debit Note</button>
            </div>
        </div>

        <!-- Header Inputs -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6 p-6 bg-white dark:bg-gray-800 rounded-lg shadow-sm">
            <div>
                <label for="vendor_id" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">1. Select Vendor</label>
                <select id="vendor_id" name="vendor_id" 
                        class="bg-gray-50 border border-gray-300 text-gray-200 text-sm rounded-lg block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600"
                        onchange="location.href = '/purchases/new-debit-note?vendor_id=' + this.value;"
                        required>
                    <option disabled {% if not selected_vendor_id %}selected{% endif %} value="">-- Select a Vendor --</option>
                    {% for vendor in vendors %}
                    <option value="{{ vendor.id }}" {% if vendor.id == selected_vendor_id %}selected{% endif %}>{{ vendor.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label for="bill_id" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">2. Select Bill</label>
                <select id="bill_id" name="original_bill_id"
                        class="bg-gray-50 border border-gray-300 text-gray-200 text-sm rounded-lg block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600"
                        onchange="location.href = '/purchases/new-debit-note?vendor_id={{ selected_vendor_id }}&bill_id=' + this.value;"
                        {% if not selected_vendor_id %}disabled{% endif %}
                        required>
                    <option disabled {% if not selected_bill %}selected{% endif %} value="">-- Select a Bill --</option>
                    {% for bill in bills_for_vendor %}
                    <option value="{{ bill.id }}" {% if selected_bill and bill.id == selected_bill.id %}selected{% endif %}>
                        {{ bill.bill_number }} ({{ bill.bill_date.strftime('%Y-%m-%d') }})
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label for="debit_note_date" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">3. Debit Note Date</label>
                <input type="date" id="debit_note_date" name="debit_note_date" class="bg-gray-50 border border-gray-300 text-gray-200 text-sm rounded-lg block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600" required>
            </div>
        </div>

        <!-- Items Table -->
        {% if selected_bill %}
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm">
            <table class="min-w-full">
                <thead class="bg-gray-50 dark:bg-gray-700">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-white uppercase">Product</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-white uppercase">Original Qty</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-white uppercase">Price</th>
                        <th class="px-6 py-3 text-center text-xs font-medium text-white uppercase w-32">Return Qty</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200 dark:divide-gray-700">
                    {% for item in selected_bill.items %}
                    <tr>
                        <td class="px-6 py-4 text-sm font-medium text-gray-400">{{ item.product.name }}</td>
                        <td class="px-6 py-4 text-sm text-right text-gray-400">{{ item.quantity }}</td>
                        <td class="px-6 py-4 text-sm text-right text-gray-400">{{ "%.2f"|format(item.price) }}</td>
                        <td class="px-6 py-4 text-gray-400">
                            <input type="hidden" name="product_id" value="{{ item.product_id }}">
                            <input type="hidden" name="price" value="{{ item.price }}">
                            <input type="number" name="return_quantity" value="0" min="0" 
                                   max="{{ item.quantity - item.returned_quantity }}" 
                                   class="bg-gray-50 border border-gray-300 text-gray-400 text-sm rounded-lg block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600">
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center py-10 text-gray-500 bg-white dark:bg-gray-800 rounded-lg shadow-sm">
            Please select a vendor and a bill to see its items.
        </div>
        {% endif %}
    </form>
</div>

<script>
    // Pre-fill the debit note date to today, if the element exists
    const dateInput = document.getElementById('debit_note_date');
    if (dateInput) {
        dateInput.value = new Date().toISOString().split('T')[0];
    }
</script>
{% endblock %}
